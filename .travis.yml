dist: trusty
matrix: 
  include:
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gdb
            - apport
            - libhdf5-serial-dev
            - g++-4.9
        env:
            - MATRIX_EVAL="USEGCC=gcc-4.9 && USECXX=g++-4.9"

language: 
  - python
  - r

cache: packages

# compiler:
#   - gcc

env:
  - PYTHON_VERSION=3.5 EDITABLE_PIP=1
  - PYTHON_VERSION=3.5 EDITABLE_PIP=0
before_install:
  - eval "${MATRIX_EVAL}"
 # https://github.com/springmeyer/travis-coredump/blob/master/.travis.yml
  - ulimit -c
  - ulimit -a -S
  - ulimit -a -H
  - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
  - chmod +x miniconda.sh
  - ./miniconda.sh -b
  - export PATH=/home/travis/miniconda3/bin:$PATH
install:
  # linking against libhdf5_cpp fails right now if we do not use this conda environment.
  # it is unclear why at this time.
  - conda create --yes -n test-env python=$PYTHON_VERSION
  - source activate test-env
  - conda install --yes numpy h5py "scikit-bio>=0.5.1" flake8 nose
  # needed for the hdf5 dev tools
  - conda install --yes -c conda-forge cython "hdf5==1.10.4" biom-format
  - sed -i "s/^CXXBASE=.*/CXXBASE=$USECXX/" `which h5c++`
  - sed -i "s/^CXXLINKERBASE=.*/CXXLINKERBASE=$USECXX/" `which h5c++`
  - export CC=`which h5c++`
  # verify both installation methods
  - 'if [ ${EDITABLE_PIP} ]; then
        pip install -e . || travis_terminate 1;
     else
        pip install . || travis_terminate 1;
     fi'
  - pushd sucpp; make test; make main; make api; make capi_test; make rapi_test; popd 
script:
  - ulimit -c unlimited -S
  - pushd sucpp; ./test_su; ./test_api; popd
  - nosetests
  - flake8 unifrac setup.py
  - ./sucpp/ssu
  # santiy test io
  - ./sucpp/ssu -i unifrac/tests/data/crawford.biom -t unifrac/tests/data/crawford.tre -o ci/test.dm -m unweighted -n 2
  - python -c "import skbio; dm = skbio.DistanceMatrix.read('ci/test.dm')"
  # merge test
  - ./sucpp/ssu -i unifrac/tests/data/crawford.biom -t unifrac/tests/data/crawford.tre -o ci/test.dm.start0.stop3 -m unweighted --mode partial --start 0 --stop 3
  - ./sucpp/ssu -i unifrac/tests/data/crawford.biom -t unifrac/tests/data/crawford.tre -o ci/test.dm.start3.stop5 -m unweighted --mode partial --start 3 --stop 5
  - ./sucpp/ssu -i unifrac/tests/data/crawford.biom -t unifrac/tests/data/crawford.tre -o ci/test.dm.partial --mode merge-partial --partial-pattern "ci/test.dm.start*"
  - exp=$(md5sum ci/test.dm | awk '{ print $1 }')
  - obs=$(md5sum ci/test.dm.partial | awk '{ print $1 }')
  - python -c "assert '${obs}' == '${exp}'"
